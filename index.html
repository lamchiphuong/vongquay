<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√≤ng Quay May M·∫Øn - Ch·ªçn Ng·∫´u Nhi√™n</title>
    
    <link rel="icon" href="favicon.png" type="image/png" sizes="64x64">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/8258/8258910.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        header {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .add-section {
            padding: 25px;
            background: #f8f9fa;
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        input[type="text"], input[type="file"] {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 50px;
            font-size: 16px;
        }

        button.add-btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        button.add-btn:hover {
            background: #5a6fd8;
        }

        .student-grid {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(10, minmax(90px, 1fr));
            gap: 16px 20px;
            justify-items: center;
            align-content: start;
            min-height: 200px;
        }

        .student-item {
            text-align: center;
            transition: all 0.3s ease;
        }

        .student-item .grid-photo,
        .student-item .grid-text-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .student-item .grid-photo {
            object-fit: cover;
        }

        .student-item .grid-text-avatar {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
        }

        .student-item .name {
            margin-top: 10px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .student-item.highlight .grid-photo,
        .student-item.highlight .grid-text-avatar {
            border-color: #ffd700;
            box-shadow: 0 0 40px #ffd700, 0 0 60px #ffea00;
        }

        .student-item.highlight {
            transform: scale(1.3);
            z-index: 10;
        }

        .control-section {
            text-align: center;
            padding: 20px 30px 30px;
            background: #f0f2f5;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        #spin-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            font-size: 24px;
            padding: 18px 60px;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
        }

        #spin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.5);
        }

        #spin-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #restart-btn, #reset-btn {
            font-size: 18px;
            padding: 14px 40px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
            color: white;
        }

        #restart-btn {
            background: linear-gradient(135deg, #26d0ce, #1a2980);
        }

        #restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(38, 208, 206, 0.5);
        }

        #reset-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        #reset-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(231, 76, 60, 0.5);
        }

        #restart-btn:disabled, #reset-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            animation: zoomIn 0.5s;
        }

        .winner-photo {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 10px solid #667eea;
            margin: 20px auto;
            display: block;
        }

        .winner-avatar {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 10px solid #667eea;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
        }

        .winner-name {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
        }

        .modal-buttons {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-remove, .btn-close, .btn-confirm, .btn-cancel {
            padding: 14px 35px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-remove, .btn-cancel { background: #e74c3c; color: white; }
        .btn-close, .btn-confirm { background: #667eea; color: white; }
        .btn-cancel { background: #999; }

        #alert-modal .modal-content {
            padding: 30px;
        }

        #alert-modal h3 {
            margin: 0 0 20px;
            font-size: 24px;
            color: #333;
        }

        #alert-message {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        @keyframes zoomIn {
            from { transform: scale(0.4); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (min-width: 1025px) {
            .student-grid {
                grid-template-columns: repeat(10, minmax(90px, 1fr));
                gap: 20px;
                padding: 30px;
            }
        }

        @media (max-width: 1024px) {
            .student-grid {
                grid-template-columns: repeat(8, minmax(85px, 1fr));
                gap: 16px;
                padding: 25px;
            }
        }

        @media (max-width: 767px) {
            .student-grid {
                grid-template-columns: repeat(5, minmax(80px, 1fr));
                gap: 12px 16px;
                padding: 20px;
            }
            .student-item .grid-photo,
            .student-item .grid-text-avatar {
                width: 70px;
                height: 70px;
                font-size: 32px;
                border-width: 4px;
            }
            .student-item .name {
                font-size: 12px;
                margin-top: 6px;
            }
        }

        @media (max-width: 480px) {
            .student-grid {
                grid-template-columns: repeat(4, minmax(70px, 1fr));
                gap: 10px 14px;
                padding: 15px;
            }
            .student-item .grid-photo,
            .student-item .grid-text-avatar {
                width: 65px;
                height: 65px;
                font-size: 28px;
            }
            .student-item .name {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>

    <audio id="spin-music" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c0cc300029.mp3" preload="auto" loop></audio>
    <audio id="win-sound" src="https://cdn.pixabay.com/audio/2025/09/13/audio_fc02fd4274.mp3" preload="auto"></audio>

    <div class="container">
        <header>
            <h1>V√≤ng Quay May M·∫Øn</h1>
            <p>Ch·ªçn ng·∫´u nhi√™n h·ªçc sinh</p>
        </header>

        <div class="add-section">
            <div class="input-group">
                <input type="text" id="student-name" placeholder="Nh·∫≠p t√™n h·ªçc sinh">
                <input type="file" id="student-photo" accept="image/*">
            </div>
            <button class="add-btn" onclick="addStudent()">Th√™m h·ªçc sinh</button>
        </div>

        <div class="student-grid" id="student-grid"></div>

        <div class="control-section">
            <button id="spin-btn" onclick="spin()">QUAY NGAY</button>
            <button id="restart-btn" onclick="restartList()">KH·ªûI ƒê·ªòNG L·∫†I</button>
            <button id="reset-btn" onclick="resetList()">X√ìA DANH S√ÅCH</button>
        </div>
    </div>

    <!-- Modal k·∫øt qu·∫£ -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <h2>üéâ Ch√∫c m·ª´ng! üéâ</h2>
            <div class="winner-name" id="winner-name"></div>
            <div id="winner-avatar-container"></div>
            <div class="modal-buttons">
                <button class="btn-remove" onclick="excludeWinner()">Lo·∫°i b·ªè</button>
                <button class="btn-close" onclick="closeModal()">Ti·∫øp t·ª•c quay</button>
            </div>
        </div>
    </div>

    <!-- Modal th√¥ng b√°o -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h3 id="alert-title">Th√¥ng b√°o</h3>
            <div id="alert-message"></div>
            <div class="modal-buttons">
                <button class="btn-close" onclick="closeAlert()">ƒê√≥ng</button>
                <button class="btn-confirm" onclick="confirmAlert()" style="display:none;">X√°c nh·∫≠n</button>
                <button class="btn-cancel" onclick="closeAlert()" style="display:none;">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        const studentGrid = document.getElementById('student-grid');
        const resultModal = document.getElementById('result-modal');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const winnerName = document.getElementById('winner-name');
        const winnerAvatarContainer = document.getElementById('winner-avatar-container');
        const spinBtn = document.getElementById('spin-btn');
        const restartBtn = document.getElementById('restart-btn');
        const resetBtn = document.getElementById('reset-btn');
        const spinMusic = document.getElementById('spin-music');
        const winSound = document.getElementById('win-sound');

        let students = [];
        let spinning = false;
        let lastWinnerIndex = -1;
        let highlightInterval = null;
        let confirmCallback = null;

        const STORAGE_KEY = 'luckyWheelStudents';

        const avatarColors = [
            '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3',
            '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39',
            '#ffeb3b', '#ffc107', '#ff9800', '#ff5722', '#795548'
        ];

        function getInitial(name) {
            return name.trim().charAt(0).toUpperCase() || '?';
        }

        function getAvatarColor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return avatarColors[Math.abs(hash % avatarColors.length)];
        }

        function showAlert(message, title = "Th√¥ng b√°o") {
            alertTitle.textContent = title;
            alertMessage.innerHTML = message.replace(/\n/g, '<br>');
            document.querySelector('#alert-modal .btn-confirm').style.display = 'none';
            document.querySelector('#alert-modal .btn-cancel').style.display = 'none';
            document.querySelector('#alert-modal .btn-close').style.display = 'inline-block';
            alertModal.style.display = 'flex';
        }

        function showConfirm(message, title = "X√°c nh·∫≠n", onConfirm) {
            alertTitle.textContent = title;
            alertMessage.innerHTML = message.replace(/\n/g, '<br>');
            document.querySelector('#alert-modal .btn-confirm').style.display = 'inline-block';
            document.querySelector('#alert-modal .btn-cancel').style.display = 'inline-block';
            document.querySelector('#alert-modal .btn-close').style.display = 'none';
            confirmCallback = onConfirm;
            alertModal.style.display = 'flex';
        }

        function closeAlert() {
            alertModal.style.display = 'none';
            confirmCallback = null;
        }

        function confirmAlert() {
            alertModal.style.display = 'none';
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
        }

        function loadSavedList() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    students = JSON.parse(saved);
                    renderGrid();
                }
            } catch (e) {
                console.error("L·ªói load:", e);
                students = [];
            }
        }

        function saveList() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(students));
            } catch (e) {
                console.error("L·ªói save:", e);
            }
        }

        function updateButtons() {
            const hasStudents = students.length > 0;
            const hasActive = getActiveStudents().length >= 2;
            restartBtn.disabled = !hasStudents;
            resetBtn.disabled = !hasStudents;
            spinBtn.disabled = !hasActive || spinning;
        }

        function addStudent() {
            const nameInput = document.getElementById('student-name');
            const photoInput = document.getElementById('student-photo');
            const name = nameInput.value.trim();

            if (!name) {
                showAlert('Vui l√≤ng nh·∫≠p t√™n h·ªçc sinh!');
                return;
            }

            if (students.some(s => s.name === name)) {
                showAlert('T√™n n√†y ƒë√£ t·ªìn t·∫°i!');
                nameInput.focus();
                return;
            }

            const resetInputs = () => {
                nameInput.value = '';
                photoInput.value = '';
                nameInput.focus();
            };

            const add = (photoDataURL = null) => {
                students.push({ name, photo: photoDataURL, excluded: false });
                renderGrid();
                saveList();
                updateButtons();
                resetInputs();
            };

            try {
                if (photoInput.files && photoInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = (e) => add(e.target.result);
                    reader.onerror = () => {
                        showAlert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ·∫£nh, v·∫´n th√™m h·ªçc sinh.");
                        add(null);
                    };
                    reader.readAsDataURL(photoInput.files[0]);
                } else {
                    add(null);
                }
            } catch (err) {
                console.error("L·ªói th√™m:", err);
                showAlert("C√≥ l·ªói khi th√™m, th·ª≠ l·∫°i nh√©!");
                resetInputs();
            }
        }

        function getActiveStudents() {
            return students.filter(s => !s.excluded);
        }

        function renderGrid() {
            studentGrid.innerHTML = '';
            students.forEach((student, realIndex) => {
                if (student.excluded) return;

                const item = document.createElement('div');
                item.className = 'student-item';
                item.dataset.realIndex = realIndex;

                let avatarHTML = student.photo
                    ? `<img class="grid-photo" src="${student.photo}" alt="${student.name}">`
                    : `<div class="grid-text-avatar" style="background-color:${getAvatarColor(student.name)}">${getInitial(student.name)}</div>`;

                item.innerHTML = `${avatarHTML}<div class="name">${student.name}</div>`;
                studentGrid.appendChild(item);
            });
            updateButtons();
        }

        function renderWinnerAvatar(student) {
            winnerAvatarContainer.innerHTML = '';
            if (student.photo) {
                const img = document.createElement('img');
                img.src = student.photo;
                img.alt = student.name;
                img.className = 'winner-photo';
                winnerAvatarContainer.appendChild(img);
            } else {
                const div = document.createElement('div');
                div.className = 'winner-avatar';
                div.style.backgroundColor = getAvatarColor(student.name);
                div.textContent = getInitial(student.name);
                winnerAvatarContainer.appendChild(div);
            }
        }

        function getSpinDuration() {
            const count = getActiveStudents().length;
            if (count === 2) return 5000;
            if (count <= 6) return 7000;
            if (count <= 10) return 8000;
            if (count <= 20) return 15000;
            if (count <= 30) return 20000;
            return 30000;
        }

        function spin() {
            if (spinning) return;
            const active = getActiveStudents();
            if (active.length < 2) {
                showAlert('C·∫ßn √≠t nh·∫•t 2 h·ªçc sinh ƒë·ªÉ quay!');
                return;
            }

            spinning = true;
            spinBtn.disabled = true;
            document.querySelectorAll('.student-item').forEach(el => el.classList.remove('highlight'));

            spinMusic.currentTime = 0;
            spinMusic.play().catch(() => {});

            const duration = getSpinDuration();
            const totalSteps = Math.floor(duration / 80);
            let step = 0;

            const winnerActiveIndex = Math.floor(Math.random() * active.length);
            const winner = active[winnerActiveIndex];
            lastWinnerIndex = students.findIndex(s => s === winner);

            if (lastWinnerIndex === -1) {
                spinning = false;
                spinBtn.disabled = false;
                return;
            }

            highlightInterval = setInterval(() => {
                document.querySelectorAll('.student-item').forEach(el => el.classList.remove('highlight'));

                const idx = (step >= totalSteps - 15) ? winnerActiveIndex : Math.floor(Math.random() * active.length);
                const curr = active[idx];
                const realIdx = students.findIndex(s => s === curr);
                const el = document.querySelector(`.student-item[data-real-index="${realIdx}"]`);
                if (el) el.classList.add('highlight');

                step++;
                if (step >= totalSteps) {
                    clearInterval(highlightInterval);
                    highlightInterval = null;
                    if (el) el.classList.add('highlight');

                    spinMusic.pause();
                    winnerName.textContent = winner.name;
                    renderWinnerAvatar(winner);
                    winSound.currentTime = 0;
                    winSound.play().catch(() => {});
                    resultModal.style.display = 'flex';

                    spinning = false;
                    updateButtons();
                }
            }, 80);
        }

        function excludeWinner() {
            if (lastWinnerIndex >= 0 && students[lastWinnerIndex]) {
                students[lastWinnerIndex].excluded = true;
                renderGrid();
                saveList();
            }
            closeModal();
        }

        function closeModal() {
            resultModal.style.display = 'none';
            document.querySelectorAll('.student-item').forEach(el => el.classList.remove('highlight'));
        }

        function restartList() {
            if (!students.length) return showAlert('Ch∆∞a c√≥ danh s√°ch!');
            showConfirm(
                'Kh·ªüi ƒë·ªông l·∫°i?<br>T·∫•t c·∫£ s·∫Ω tham gia quay l·∫°i t·ª´ ƒë·∫ßu.',
                'Kh·ªüi ƒë·ªông l·∫°i',
                () => {
                    students.forEach(s => s.excluded = false);
                    renderGrid();
                    saveList();
                    showAlert('ƒê√£ kh·ªüi ƒë·ªông l·∫°i!');
                }
            );
        }

        function resetList() {
            if (!students.length) return showAlert('Danh s√°ch ƒë√£ tr·ªëng!');
            showConfirm(
                '‚ö†Ô∏è X√ìA TO√ÄN B·ªò danh s√°ch?<br>Kh√¥ng th·ªÉ kh√¥i ph·ª•c!',
                'X√≥a danh s√°ch',
                () => {
                    students = [];
                    localStorage.removeItem(STORAGE_KEY);
                    renderGrid();
                    spinning = false;
                    if (highlightInterval) clearInterval(highlightInterval);
                    document.querySelectorAll('.student-item').forEach(el => el.classList.remove('highlight'));
                    updateButtons();
                    showAlert('ƒê√£ x√≥a to√†n b·ªô danh s√°ch!');
                }
            );
        }

        window.onload = () => {
            loadSavedList();
            updateButtons();
        };

        window.onclick = e => {
            if (e.target === resultModal) closeModal();
            if (e.target === alertModal) closeAlert();
        };
    </script>
</body>
</html>
